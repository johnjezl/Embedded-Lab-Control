# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

## [Unreleased]

### Added
- Project documentation structure
  - ARCHITECTURE.md - System design and component specifications
  - IMPLEMENTATION.md - Milestone-based TODO lists
  - AGENT_RULES.md - Development process and standards
  - STATUS.md - Current project state tracking
  - CHANGELOG.md - This file
- M1.1 Project Setup (2025-12-31)
  - Created project directory structure (src/labctl, tests, scripts, config, docs)
  - Added pyproject.toml with dependencies (click, pyyaml, requests)
  - Created virtual environment with dev tools (pytest, black, isort, flake8)
  - Installed ser2net system package
- M1.2 udev Rules System (2025-12-31)
  - Created `scripts/discover-usb-serial.sh` for USB device enumeration
  - Created `scripts/generate-udev-rules.py` for rule generation from YAML mapping
  - Created `scripts/install-udev.sh` for udev rules installation
  - Created `docs/HARDWARE_MAP.md` with USB topology documentation
  - Symlinks now created under `/dev/lab/` for deterministic device access
- M1.3 ser2net Configuration (2025-12-31)
  - Created `src/labctl/serial/ser2net.py` for config generation
  - Support for baud rate, parity, local-only connections
  - Generated config for 5 ports on TCP 4000-4004
  - All ports verified accessible via TCP
- M1.4 Basic CLI Structure (2025-12-31)
  - Created `src/labctl/cli.py` with Click framework
  - Implemented `labctl ports` - lists configured serial ports with TCP mappings
  - Implemented `labctl connect <port>` - connects via TCP or direct serial
  - Added 8 CLI integration tests
- M1.5 Configuration File (2025-12-31)
  - Created `src/labctl/core/config.py` with Config dataclasses
  - YAML config loading from ~/.config/labctl/config.yaml
  - Environment variable overrides (LABCTL_DEV_DIR, LABCTL_BASE_TCP_PORT, etc.)
  - Added `-c/--config` CLI option
  - Added 17 unit tests for config module
  - **Milestone 1 Complete!**
- M2.1-2.5 Data Layer (2025-12-31)
  - Created `src/labctl/core/database.py` with SQLite schema
    - Tables: sbcs, serial_ports, network_addresses, power_plugs, status_log, audit_log
    - Foreign keys with cascade delete
    - Schema versioning support
  - Created `src/labctl/core/models.py` with data models
    - SBC, SerialPort, NetworkAddress, PowerPlug dataclasses
    - Status, PortType, AddressType, PlugType enums
    - from_row() methods for database deserialization
  - Created `src/labctl/core/manager.py` with ResourceManager
    - Full CRUD operations for SBCs
    - Serial port, network address, power plug assignment
    - Audit logging for all operations
  - Added CLI SBC management commands
    - `labctl list` - tabular output with filters (--project, --status)
    - `labctl add <name>` - create SBC with options
    - `labctl remove <name>` - delete with confirmation
    - `labctl info <name>` - detailed SBC view
    - `labctl edit <name>` - update properties
  - Added CLI port assignment commands
    - `labctl port assign <sbc> <type> <device>` - with auto TCP port
    - `labctl port remove <sbc> <type>`
    - `labctl port list` - all port assignments
  - Added 27 new tests (8 database, 19 manager)
  - Total: 62 tests passing
- M2.6-2.7 Network and ser2net Commands (2025-12-31)
  - Added `labctl network set <sbc> <type> <ip>` with --mac, --hostname options
  - Added `labctl network remove <sbc> <type>`
  - Added `labctl ser2net generate` - generates config from database
    - Supports --output file and --install flag
  - Added `labctl ser2net reload` - restarts ser2net service
  - **Milestone 2 Complete!**
- M3 Power Control (2025-12-31)
  - Created power module `src/labctl/power/` with controller framework
    - PowerController ABC with power_on, power_off, power_cycle, get_state
    - PowerState enum (ON, OFF, UNKNOWN)
    - Factory function get_controller() for plug type dispatch
  - Implemented TasmotaController for Tasmota smart plugs
    - HTTP API client with multi-relay support
  - Implemented ShellyController for Shelly devices
  - Implemented KasaController stub for TP-Link Kasa (requires python-kasa)
  - Added CLI plug commands
    - `labctl plug assign <sbc> <type> <address>` with --index option
    - `labctl plug remove <sbc>`
  - Added CLI power commands
    - `labctl power on/off/cycle/status <sbc>`
    - `labctl power-all on|off` with --project filter
  - Added 19 power module tests (81 total)
  - **Milestone 3 Complete!**
- M4 CLI Completion (2025-12-31)
  - Added `labctl console <sbc>` - connect to SBC's serial console by name
    - Looks up port from database, supports --type for jtag/debug
  - Added `labctl ssh <sbc>` - SSH to SBC by name
    - Looks up IP from database, uses configured ssh_user
    - Supports --user override
  - Added `labctl status` - overview with color-coded status and power state
  - Added `labctl export` - export SBCs to YAML/JSON
  - Added `labctl import <file>` - import SBCs with --update option
  - Added `labctl completion` - shell completion for bash/zsh/fish
  - **Milestone 4 Complete!**
- M5 Web Interface (2025-12-31)
  - Created Flask web module with application factory pattern
  - Implemented REST API endpoints:
    - `GET/POST /api/sbcs` - list and create SBCs
    - `GET/PUT/DELETE /api/sbcs/<name>` - CRUD operations
    - `GET/POST /api/sbcs/<name>/power` - power status and control
    - `GET /api/ports` - list serial ports
    - `GET /api/health` and `/api/status` - system status
  - Created web dashboard with dark theme:
    - Dashboard page with SBC card grid
    - SBC detail page with all information
    - Power control buttons (on/off/cycle)
    - Status indicators and responsive layout
  - Added `labctl web` command with --host, --port, --debug options
  - **Milestone 5 Complete!**
- M6 Multi-Client Serial Access (2026-01-01)
  - Created serial proxy module `src/labctl/serial/proxy.py`
    - SerialProxy class with asyncio-based fan-out architecture
    - First-writer-wins write lock policy
    - Multiple readers can view console output simultaneously
    - ProxyManager for managing multiple proxy instances
  - Added session logging
    - SessionLogger class for timestamped traffic logs
    - Logs stored in ~/.local/share/labctl/logs/
    - Format: [timestamp] [direction] data
  - Added ProxyConfig to config.py
    - Configurable port range (default 5000-5099)
    - Write policy selection (first, all, queue)
    - Max clients per proxy, idle timeout
  - Added CLI proxy commands
    - `labctl proxy start <sbc>` - start proxy for SBC (foreground)
    - `labctl proxy list` - list running proxies (placeholder)
    - `labctl sessions [sbc]` - list connected clients (placeholder)
  - Added web console with xterm.js
    - WebSocket bridge for browser-to-proxy communication
    - Console page at /sbc/<name>/console
    - Full terminal emulator in browser
  - Added 26 proxy tests (143 total)
  - **Milestone 6 Complete!**
- M7 Monitoring and Health (2026-01-01)
  - Created health check module `src/labctl/health/`
    - HealthChecker class with ping, serial, and power checks
    - CheckResult and HealthCheckSummary dataclasses
    - Automatic status determination based on check results
  - Added alerting framework
    - Alert and AlertLevel for structured notifications
    - AlertHandler ABC with pluggable handlers
    - LogAlertHandler for file-based alerts
    - ConsoleAlertHandler for terminal output
    - EmailAlertHandler and SlackAlertHandler stubs for future
    - AlertManager for dispatching to multiple handlers
  - Created monitoring daemon
    - MonitorDaemon class for periodic health checks
    - Configurable check interval
    - Automatic status updates on check results
    - Alert triggering on status/power changes
  - Added status tracking
    - log_status() method writes to status_log table
    - get_status_history() for retrieving history
    - cleanup_old_status_logs() for retention management
  - Added HealthConfig to configuration
    - check_interval, ping_timeout, serial_timeout
    - status_retention_days, alert_log_path
    - alert_on_offline, alert_on_power_change options
  - Added CLI commands
    - `labctl health-check` - run health checks on SBCs
      - --type ping|serial|power|all filter
      - --sbc to check single SBC
      - --update to update status in database
    - `labctl monitor` - start monitoring daemon
      - --interval to override check frequency
      - --no-update, --no-alerts options
  - Added web endpoints
    - GET /api/sbcs/<name>/history - status history
    - GET /api/health/check - run health checks via API
    - Status history page at /sbc/<name>/history
  - Added 28 health module tests (171 total)
  - **Milestone 7 Complete!**

### Changed
- Moved documentation files to docs/ folder (AGENT_RULES.md, IMPLEMENTATION.md, DECISIONS.md)
- Fixed README.md and CLAUDE.md paths to reference docs/ folder

### Fixed
- Nothing yet

---

## Version History

_No releases yet. Development starting with Milestone 1._
